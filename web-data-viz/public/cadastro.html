<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>Saint Peter TECH | Cadastro</title>

  <script src="./js/sessao.js"></script>

  <!-- Importando style.css -->
  <link rel="stylesheet" href="./css/style.css" />
  <!-- Fonte -->
  <link href="https://fonts.cdnfonts.com/css/centrale-sans-regular" rel="stylesheet">
  <!-- Emoji -->
  <link href="https://emoji-css.afeld.me/emoji.css" rel="stylesheet">

  <!-- <link rel="stylesheet" href="./css/estilo.css" /> -->
  <link rel="icon" href="./assets/Logo_coruja_no_bg.png" />
  <link rel="preconnect" href="https://fonts.gstatic.com" />
</head>

<body onload="listar()">
  <!--header inicio-->
  <div class="header">
    <div class="container">

      <div class="logo">
        <img src="./assets/Logo_coruja_no_bg.png" alt="">
        <h1 class="titulo">Saint Peter Tech</h1>
      </div>
      <ul class="navbar">
        <li>
          <a href="index.html">Sobre Nós</a>
        </li>
        <li>
          <a href="simulador.html">Simulador</a>
        </li>
        <li>|</li>
        <li>
          <a href="login.html">Login</a>
        </li>
        <li class="agora">
          <a href="#">Cadastro</a>
        </li>
      </ul>
    </div>
  </div>
  <!--header fim-->

  <div class="login">
    <div class="alerta_erro">
      <div class="card_erro" id="cardErro">
        <span id="mensagem_erro"></span>
      </div>

      <!-- div contaúdo da senha -->
      <div id="div_msg_senha" class="msg_senha">
        <span>A senha deve conter:</span>
        <br><br>
        <div class="check">
          <img id="img_tamanho" src="./assets/icon_x_no_bg.png" alt="img X">
          Pelo menos 6 caracteres
        </div>
        <div class="check">
          <img id="img_maiuscula" src="./assets/icon_x_no_bg.png" alt="img X">
          Letra maiúscula
        </div>
        <div class="check">
          <img id="img_minuscula" src="./assets/icon_x_no_bg.png" alt="img X">
          Letra minúscula
        </div>
        <div class="check">
          <img id="img_num" src="./assets/icon_x_no_bg.png" alt="img X">
          Número
        </div>
        <div class="check">
          <img id="img_especial" src="./assets/icon_x_no_bg.png" alt="img X">
          Caractere especial
        </div>
      </div>

    </div>
    <div class="container">
      <div class="card card-cadastro">
        <h2>Bem-vindo!</h2>
        <div class="formulario">
          <!--
                         Para inserir mais um campo, copie uma das inputs abaixo.
                         Assim que inserir vá para o script abaixo.
                     -->
          <div class="campo">
            <span>Código de ativação:</span>
            <input id="input_codigo" type="text" placeholder="Insira aqui seu código" />
          </div>
          <div class="campo">
            <span>Nome:</span>
            <input id="input_nome" type="text" placeholder="Seu nome" />
          </div>
          <div class="campo">
            <span>E-mail:</span>
            <input id="input_email" type="text" placeholder="meuemail@provedor.com" />
          </div>
          <div class="campo">
            <span>Senha:</span>
            <input id="input_senha" type="password" placeholder="******" onfocus="mostrar()" onblur="esconder()"
              oninput="verificar_senha()" />
          </div>
          <div class="campo">
            <span>Confirmação da Senha:</span>
            <input id="input_confirmacao_senha" type="password" placeholder="******" />
          </div>
          <button class="botao" onclick="cadastrar()">Cadastrar</button>
        </div>
        <div id="div_aguardar" class="loading-div">
          <img src="./assets/circle-loading.gif" id="loading-gif" />
        </div>

        <div id="div_erros_login"></div>
      </div>
    </div>
  </div>

  <!--footer inicio-->
  <div class="footer">
    <div class="footer_left">
      <div class="nossos">
        <h3>Nossas Redes Sociais</h3>
        <br>
        <img src="./assets/logo_insta.png" alt="">
        <br>
        <img src="./assets/logo_fb.png" alt="">
        <br>
        <img src="./assets/logo_whats.png" alt="">
      </div>
      <div class="nossos">
        <h3>Nossos serviços</h3>
        <br><br>
        <li>
          <a href="index.html">Sobre Nós</a>
        </li>
        <li>
          <a href="simulador.html">Simulador</a>
        </li>
        <li>
          <a href="login.html">Login</a>
        </li>
        <li>
          <a href="#">Cadastro</a>
        </li>

      </div>
    </div>
    <div class="footer_right">
      <div class="footer_linha"></div>
      <div class="dados">
        <p>
          <i class="em em-round_pushpin" aria-role="presentation" aria-label="ROUND PUSHPIN"></i> Endereço
          <br>
          Rua Haddoc Lobo , 595
          <br>
          3º Andar
          <br>
          01268- 180
        </p>
        <br>
        <p>
          <i class="em em-phone" aria-role="presentation" aria-label="BLACK TELEPHONE"></i> Contato
          <br>
          +55 (11) 9999-9999
          <br>
          saintpetertech@suporte.com
        </p>
      </div>
    </div>

  </div>
  <!--footer fim-->
</body>

</html>

<script>

  // Array para armazenar empresas cadastradas para validação de código de ativação 
  let listaEmpresasCadastradas = [];

  // Mostrar requisitos para senha forte:
  function mostrar() {
    div_msg_senha.style.display = 'block'
  }

  // Esconder requisitos para senha forte:
  function esconder() {
    div_msg_senha.style.display = 'none'
  }

  var criteriosAtendidos = 0;

  // Verificar se a senha é forte:
  function verificar_senha() {

    var senha = input_senha.value;
    var trimmedSenha = senha.trim();
    var tamanhoSenha = trimmedSenha.length;
    var senhaMinuscula = senha.toLocaleLowerCase();
    var senhaMaiuscula = senha.toLocaleUpperCase();

    var criterio1 = 0;
    var criterio2 = 0;
    var criterio3 = 0;
    var criterio4 = 0;
    var criterio5 = 0;

    img_tamanho.src = "./assets/icon_x_no_bg.png"
    img_maiuscula.src = "./assets/icon_x_no_bg.png"
    img_minuscula.src = "./assets/icon_x_no_bg.png"
    img_num.src = "./assets/icon_x_no_bg.png"
    img_especial.src = "./assets/icon_x_no_bg.png"

    // Tem pelo menos 6 caracteres:
    if (tamanhoSenha >= 6) {
      criterio1 = 1;
      img_tamanho.src = "./assets/icon_ok_no_bg.png";
    }

    // Tem letra maúscula:
    if (senhaMinuscula != senha) {
      criterio2 = 1;
      img_maiuscula.src = "./assets/icon_ok_no_bg.png";
    }

    // Tem letra minúscula:
    if (senhaMaiuscula != senha) {
      criterio3 = 1;
      img_minuscula.src = "./assets/icon_ok_no_bg.png";
    }

    // Tem número:
    listaNumeros = ["0", "1", "2", "3", "4", "5", "6", "7", "8", "9"]

    for (var i = 0; i < listaNumeros.length; i++) {
      if (senha.includes(listaNumeros[i])) {
        criterio4 = 1;
        img_num.src = "./assets/icon_ok_no_bg.png";
      }
    }

    // Tem caractere especial:
    listaEspeciais = ["!", "@", "#", "$", "%", "^", "&", "*", "(", ")", "+", "=", "{", "}", ";", ":", "?", "/", "`", "~", ",", ".", "[", "]", "|", "¨"]

    for (var i = 0; i < listaEspeciais.length; i++) {
      if (senha.includes(listaEspeciais[i])) {
        criterio5 = 1;
        img_especial.src = "./assets/icon_ok_no_bg.png";
      }
    }

    criteriosAtendidos = criterio1 + criterio2 + criterio3 + criterio4 + criterio5
  }

  function cadastrar() {
    // aguardar();

    //Recupere o valor da nova input pelo nome do id
    // Agora vá para o método fetch logo abaixo
    var nomeVar = input_nome.value;
    var emailVar = input_email.value;
    var senhaVar = input_senha.value;
    var confirmacaoSenhaVar = input_confirmacao_senha.value;
    var codigoVar = input_codigo.value;
    var idEmpresaVincular

    // Verificando se há algum campo em branco
    if (
      nomeVar == "" ||
      emailVar == "" ||
      senhaVar == "" ||
      confirmacaoSenhaVar == "" ||
      codigoVar == ""
    ) {
      cardErro.style.display = "block";
      mensagem_erro.innerHTML =
        "Preencha todos os campos para poder prosseguir.";

      finalizarAguardar();
      setInterval(sumirMensagem, 10000);
      return false;
    } else if (nomeVar.length < 3) {
      cardErro.style.display = "block";
      mensagem_erro.innerHTML =
        "O nome deve ter no mínimo 3 caracteres.";

      finalizarAguardar();
      setInterval(sumirMensagem, 10000);
      return false;
    } else if (!emailVar.includes("@") || !emailVar.includes(".com") && !emailVar.includes(".br")) {
      cardErro.style.display = "block";
      mensagem_erro.innerHTML =
        "O e-mail deve conter @ e terminar em .com ou .br.";

      finalizarAguardar();
      setInterval(sumirMensagem, 10000);
      return false;
    } else if (criteriosAtendidos < 5) {
      cardErro.style.display = "block";
      mensagem_erro.innerHTML =
        "A senha deve conter todos os requisitos.";

      finalizarAguardar();
      setInterval(sumirMensagem, 10000);
      return false;
    } else if (confirmacaoSenhaVar != senhaVar) {
      cardErro.style.display = "block";
      mensagem_erro.innerHTML =
        "A confirmação está diferente da senha.";

      finalizarAguardar();
      setInterval(sumirMensagem, 10000);
      return false;
    } else {



      // Verificando se o código de ativação é de alguma empresa cadastrada
      for (let i = 0; i < listaEmpresasCadastradas.length; i++) {
        if (listaEmpresasCadastradas[i].codigo_ativacao == codigoVar) {
          idEmpresaVincular = listaEmpresasCadastradas[i].id
          console.log("Código de ativação válido.");
          break;
        } else {
          cardErro.style.display = "block";
          mensagem_erro.innerHTML = "O código de ativação é inválido";
          finalizarAguardar();
          setInterval(sumirMensagem, 10000);
        }
      }

      // Enviando o valor da nova input
      fetch("/usuarios/cadastrar", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          // crie um atributo que recebe o valor recuperado aqui
          // Agora vá para o arquivo routes/usuario.js
          nomeServer: nomeVar,
          emailServer: emailVar,
          senhaServer: senhaVar,
          idEmpresaVincularServer: idEmpresaVincular
        }),
      })
        .then(function (resposta) {
          console.log("resposta: ", resposta);

          if (resposta.ok) {
            cardErro.style.display = "block";

            mensagem_erro.innerHTML =
              "Cadastro realizado com sucesso! Redirecionando para tela de Login...";

            setTimeout(() => {
              window.location = "login.html";
            }, "2000");

            limparFormulario();
            finalizarAguardar();
          } else {
            throw "Houve um erro ao tentar realizar o cadastro!";
          }
        })
        .catch(function (resposta) {
          console.log(`#ERRO: ${resposta}`);
          finalizarAguardar();
        });

      return false;
    }
  }

  // Listando empresas cadastradas 
  function listar() {
    fetch("/empresas/listar", {
      method: "GET",
    })
      .then(function (resposta) {
        resposta.json().then((empresas) => {
          empresas.forEach((empresa) => {
            listaEmpresasCadastradas.push(empresa);

            console.log("listaEmpresasCadastradas")
            console.log(listaEmpresasCadastradas[0].codigo_ativacao)
          });
        });
      })
      .catch(function (resposta) {
        console.log(`#ERRO: ${resposta}`);
      });
  }

  function sumirMensagem() {
    cardErro.style.display = "none";
  }
</script>